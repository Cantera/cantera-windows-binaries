name: Build MSI
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  MW_HEADERS_DIR: ${{ github.workspace }}/mw_headers

jobs:
  build-python:
    name: Build Matlab Package on ${{ matrix.arch }}
    runs-on: windows-latest
    strategy:
      matrix:
        arch: ['x86', 'x64']
      fail-fast: false
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v2
      - name: Checkout the Cantera repository
        uses: actions/checkout@v2
        with:
          submodules: recursive
          repository: Cantera/cantera
          path: cantera
          ref: main
      # The known_hosts key is generated with `ssh-keygen -F cantera.org` from a
      # machine that has previously logged in to cantera.org and trusts
      # that it logged in to the right machine
      - name: Set up SSH key and host for deploy
        if: matrix.MATLAB == 0
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.CTDEPLOY_SSH_KEY }}
          known_hosts: ${{ secrets.CTDEPLOY_KNOWN_HOSTS }}
      - name: Get the MATLAB headers
        run: git clone ssh://ctdeploy@cantera.org/mw_headers.git "${MW_HEADERS_DIR}"
        shell: bash
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.9"
          architecture: ${{ matrix.arch }}
      - name: Install Python dependencies
        run: |
          python -m pip install -U pip setuptools
          python -m pip install scons pypiwin32 numpy ruamel.yaml cython
      - name: Build Cantera
        run: build.bat
        env:
          BUILD_ARCH: ${{ matrix.arch }}
        shell: cmd
      - name: Upload the MSI artifact
        uses: actions/upload-artifact@v2
        with:
          path: 'cantera/*.msi'
